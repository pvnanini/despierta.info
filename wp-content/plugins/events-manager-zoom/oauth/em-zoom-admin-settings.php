<?php
namespace EM_OAuth;

class Zoom_API_Admin_Settings extends OAuth_API_Admin_Settings {
	public static $icon_url;

	public static function init(){
	    parent::init();
		if( is_admin() && !empty($_REQUEST['create_zoom_attendee_form']) ){
			add_action('admin_init', 'EM_OAuth\Zoom_API_Admin_Settings::create_zoom_attendee_form');
		}
    }
    
    public static function create_zoom_attendee_form(){
		global $wpdb, $EM_Notices; /* @var \EM_Notices $EM_Notices */
		if( !empty($_REQUEST['create_zoom_attendee_form'])  && wp_verify_nonce($_REQUEST['create_zoom_attendee_form'], 'create-zoom-attedee-form') && current_user_can('manage_options') ){
			$zoom_attendee_data = array ('name' => esc_html__('Zoom Attendee', 'events-manager-zoom'),'form' => array ('attendee_intro' => array ('label' => 'Title','fieldid' => 'attendee_intro','type' => 'html','required' => '','options_select_values' => '','options_select_default' => '','options_select_default_text' => 'Select ...','options_select_tip' => '','options_select_error' => '','options_html_content' => '<strong>Attendee #NUM#</strong>','options_date_range' => '','options_date_range_seperator' => '','options_date_tip' => '','options_date_error' => '','options_date_error_format' => '','options_date_error_end' => '','options_time_range' => '','options_time_range_seperator' => '','options_time_tip' => '','options_time_error' => '','options_time_error_format' => '','options_time_error_end' => '','options_time_error_start' => '','options_selection_values' => '','options_selection_tip' => '','options_selection_error' => '','options_checkbox_checked' => '','options_checkbox_tip' => '','options_checkbox_error' => '','options_text_tip' => '','options_text_regex' => '','options_text_error' => '',),'first_name' => array ('label' => 'First Name','fieldid' => 'first_name','type' => 'text','required' => '1','options_select_values' => '','options_select_default' => '','options_select_default_text' => 'Select ...','options_select_tip' => '','options_select_error' => '','options_html_content' => '','options_date_range' => '','options_date_range_seperator' => '','options_date_tip' => '','options_date_error' => '','options_date_error_format' => '','options_date_error_end' => '','options_time_range' => '','options_time_range_seperator' => '','options_time_tip' => '','options_time_error' => '','options_time_error_format' => '','options_time_error_end' => '','options_time_error_start' => '','options_selection_values' => '','options_selection_tip' => '','options_selection_error' => '','options_checkbox_checked' => '','options_checkbox_tip' => '','options_checkbox_error' => '','options_text_tip' => '','options_text_regex' => '','options_text_error' => '',),'last_name' => array ('label' => 'Last Name','fieldid' => 'last_name','type' => 'text','required' => '1','options_select_values' => '','options_select_default' => '','options_select_default_text' => 'Select ...','options_select_tip' => '','options_select_error' => '','options_html_content' => '','options_date_range' => '','options_date_range_seperator' => '','options_date_tip' => '','options_date_error' => '','options_date_error_format' => '','options_date_error_end' => '','options_time_range' => '','options_time_range_seperator' => '','options_time_tip' => '','options_time_error' => '','options_time_error_format' => '','options_time_error_end' => '','options_time_error_start' => '','options_selection_values' => '','options_selection_tip' => '','options_selection_error' => '','options_checkbox_checked' => '','options_checkbox_tip' => '','options_checkbox_error' => '','options_text_tip' => '','options_text_regex' => '','options_text_error' => '',),'email' => array ('label' => 'Email','fieldid' => 'email','type' => 'text','required' => '1','options_select_values' => '','options_select_default' => '','options_select_default_text' => 'Select ...','options_select_tip' => '','options_select_error' => '','options_html_content' => '','options_date_range' => '','options_date_range_seperator' => '','options_date_tip' => '','options_date_error' => '','options_date_error_format' => '','options_date_error_end' => '','options_time_range' => '','options_time_range_seperator' => '','options_time_tip' => '','options_time_error' => '','options_time_error_format' => '','options_time_error_end' => '','options_time_error_start' => '','options_selection_values' => '','options_selection_tip' => '','options_selection_error' => '','options_checkbox_checked' => '','options_checkbox_tip' => '','options_checkbox_error' => '','options_text_tip' => '','options_text_regex' => '^(([^<>()\\[\\]\\\\.,;:\\s@"]+(\\.[^<>()\\[\\]\\\\.,;:\\s@"]+)*)|(".+"))@((\\[[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}])|(([a-zA-Z\\-0-9]+\\.)+[a-zA-Z]{2,}))$','options_text_error' => 'Please supply a valid email.',),'phone' => array ('label' => 'Phone','fieldid' => 'phone','type' => 'text','required' => '','options_select_values' => '','options_select_default' => '','options_select_default_text' => 'Select ...','options_select_tip' => '','options_select_error' => '','options_html_content' => '','options_date_range' => '','options_date_range_seperator' => '','options_date_tip' => '','options_date_error' => '','options_date_error_format' => '','options_date_error_end' => '','options_time_range' => '','options_time_range_seperator' => '','options_time_tip' => '','options_time_error' => '','options_time_error_format' => '','options_time_error_end' => '','options_time_error_start' => '','options_selection_values' => '','options_selection_tip' => '','options_selection_error' => '','options_checkbox_checked' => '','options_checkbox_tip' => '','options_checkbox_error' => '','options_text_tip' => '','options_text_regex' => '','options_text_error' => '',),'address' => array ('label' => 'Address','fieldid' => 'address','type' => 'text','required' => '','options_select_values' => '','options_select_default' => '','options_select_default_text' => 'Select ...','options_select_tip' => '','options_select_error' => '','options_html_content' => '','options_date_range' => '','options_date_range_seperator' => '','options_date_tip' => '','options_date_error' => '','options_date_error_format' => '','options_date_error_end' => '','options_time_range' => '','options_time_range_seperator' => '','options_time_tip' => '','options_time_error' => '','options_time_error_format' => '','options_time_error_end' => '','options_time_error_start' => '','options_selection_values' => '','options_selection_tip' => '','options_selection_error' => '','options_checkbox_checked' => '','options_checkbox_tip' => '','options_checkbox_error' => '','options_text_tip' => '','options_text_regex' => '','options_text_error' => '',),'city' => array ('label' => 'City','fieldid' => 'city','type' => 'text','required' => '','options_select_values' => '','options_select_default' => '','options_select_default_text' => 'Select ...','options_select_tip' => '','options_select_error' => '','options_html_content' => '','options_date_range' => '','options_date_range_seperator' => '','options_date_tip' => '','options_date_error' => '','options_date_error_format' => '','options_date_error_end' => '','options_time_range' => '','options_time_range_seperator' => '','options_time_tip' => '','options_time_error' => '','options_time_error_format' => '','options_time_error_end' => '','options_time_error_start' => '','options_selection_values' => '','options_selection_tip' => '','options_selection_error' => '','options_checkbox_checked' => '','options_checkbox_tip' => '','options_checkbox_error' => '','options_text_tip' => '','options_text_regex' => '','options_text_error' => '',),'state' => array ('label' => 'State','fieldid' => 'state','type' => 'text','required' => '','options_select_values' => '','options_select_default' => '','options_select_default_text' => 'Select ...','options_select_tip' => '','options_select_error' => '','options_html_content' => '','options_date_range' => '','options_date_range_seperator' => '','options_date_tip' => '','options_date_error' => '','options_date_error_format' => '','options_date_error_end' => '','options_time_range' => '','options_time_range_seperator' => '','options_time_tip' => '','options_time_error' => '','options_time_error_format' => '','options_time_error_end' => '','options_time_error_start' => '','options_selection_values' => '','options_selection_tip' => '','options_selection_error' => '','options_checkbox_checked' => '','options_checkbox_tip' => '','options_checkbox_error' => '','options_text_tip' => '','options_text_regex' => '','options_text_error' => '',),'zip' => array ('label' => 'Post Code','fieldid' => 'zip','type' => 'text','required' => '','options_select_values' => '','options_select_default' => '','options_select_default_text' => 'Select ...','options_select_tip' => '','options_select_error' => '','options_html_content' => '','options_date_range' => '','options_date_range_seperator' => '','options_date_tip' => '','options_date_error' => '','options_date_error_format' => '','options_date_error_end' => '','options_time_range' => '','options_time_range_seperator' => '','options_time_tip' => '','options_time_error' => '','options_time_error_format' => '','options_time_error_end' => '','options_time_error_start' => '','options_selection_values' => '','options_selection_tip' => '','options_selection_error' => '','options_checkbox_checked' => '','options_checkbox_tip' => '','options_checkbox_error' => '','options_text_tip' => '','options_text_regex' => '','options_text_error' => '',),'country' => array ('label' => 'Country','fieldid' => 'country','type' => 'country','required' => '','options_select_values' => '','options_select_default' => '','options_select_default_text' => 'Select ...','options_select_tip' => '','options_select_error' => '','options_html_content' => '','options_date_range' => '','options_date_range_seperator' => '','options_date_tip' => '','options_date_error' => '','options_date_error_format' => '','options_date_error_end' => '','options_time_range' => '','options_time_range_seperator' => '','options_time_tip' => '','options_time_error' => '','options_time_error_format' => '','options_time_error_end' => '','options_time_error_start' => '','options_selection_values' => '','options_selection_tip' => '','options_selection_error' => '','options_checkbox_checked' => '','options_checkbox_tip' => '','options_checkbox_error' => '','options_text_tip' => '','options_text_regex' => '','options_text_error' => '',),'purchasing_time_frame' => array ('label' => 'Purchasing Time','fieldid' => 'purchasing_time_frame','type' => 'select','required' => '','options_select_values' => 'Within a month'."\r\n".'1-3 months'."\r\n".'4-6 months'."\r\n".'More than 6 months'."\r\n".'No timeframe','options_select_default' => '','options_select_default_text' => 'Select ...','options_select_tip' => '','options_select_error' => '','options_html_content' => '','options_date_range' => '','options_date_range_seperator' => '','options_date_tip' => '','options_date_error' => '','options_date_error_format' => '','options_date_error_end' => '','options_time_range' => '','options_time_range_seperator' => '','options_time_tip' => '','options_time_error' => '','options_time_error_format' => '','options_time_error_end' => '','options_time_error_start' => '','options_selection_values' => '','options_selection_tip' => '','options_selection_error' => '','options_checkbox_checked' => '','options_checkbox_tip' => '','options_checkbox_error' => '','options_text_tip' => '','options_text_regex' => '','options_text_error' => '',),'industry' => array ('label' => 'Industry','fieldid' => 'industry','type' => 'text','required' => '','options_select_values' => '','options_select_default' => '','options_select_default_text' => 'Select ...','options_select_tip' => '','options_select_error' => '','options_html_content' => '','options_date_range' => '','options_date_range_seperator' => '','options_date_tip' => '','options_date_error' => '','options_date_error_format' => '','options_date_error_end' => '','options_time_range' => '','options_time_range_seperator' => '','options_time_tip' => '','options_time_error' => '','options_time_error_format' => '','options_time_error_end' => '','options_time_error_start' => '','options_selection_values' => '','options_selection_tip' => '','options_selection_error' => '','options_checkbox_checked' => '','options_checkbox_tip' => '','options_checkbox_error' => '','options_text_tip' => '','options_text_regex' => '','options_text_error' => '',),'org' => array ('label' => 'Organization','fieldid' => 'org','type' => 'text','required' => '','options_select_values' => '','options_select_default' => '','options_select_default_text' => 'Select ...','options_select_tip' => '','options_select_error' => '','options_html_content' => '','options_date_range' => '','options_date_range_seperator' => '','options_date_tip' => '','options_date_error' => '','options_date_error_format' => '','options_date_error_end' => '','options_time_range' => '','options_time_range_seperator' => '','options_time_tip' => '','options_time_error' => '','options_time_error_format' => '','options_time_error_end' => '','options_time_error_start' => '','options_selection_values' => '','options_selection_tip' => '','options_selection_error' => '','options_checkbox_checked' => '','options_checkbox_tip' => '','options_checkbox_error' => '','options_text_tip' => '','options_text_regex' => '','options_text_error' => '',),'job_title' => array ('label' => 'Job Title','fieldid' => 'job_title','type' => 'text','required' => '','options_select_values' => '','options_select_default' => '','options_select_default_text' => 'Select ...','options_select_tip' => '','options_select_error' => '','options_html_content' => '','options_date_range' => '','options_date_range_seperator' => '','options_date_tip' => '','options_date_error' => '','options_date_error_format' => '','options_date_error_end' => '','options_time_range' => '','options_time_range_seperator' => '','options_time_tip' => '','options_time_error' => '','options_time_error_format' => '','options_time_error_end' => '','options_time_error_start' => '','options_selection_values' => '','options_selection_tip' => '','options_selection_error' => '','options_checkbox_checked' => '','options_checkbox_tip' => '','options_checkbox_error' => '','options_text_tip' => '','options_text_regex' => '','options_text_error' => '',),'role_in_purchase_process' => array ('label' => 'Role in Purchase Process','fieldid' => 'role_in_purchase_process','type' => 'select','required' => '','options_select_values' => 'Decision Maker'."\r\n".'Evaluator/Recommender'."\r\n".'Influencer'."\r\n".'Not involved','options_select_default' => '','options_select_default_text' => 'Select ...','options_select_tip' => '','options_select_error' => '','options_html_content' => '','options_date_range' => '','options_date_range_seperator' => '','options_date_tip' => '','options_date_error' => '','options_date_error_format' => '','options_date_error_end' => '','options_time_range' => '','options_time_range_seperator' => '','options_time_tip' => '','options_time_error' => '','options_time_error_format' => '','options_time_error_end' => '','options_time_error_start' => '','options_selection_values' => '','options_selection_tip' => '','options_selection_error' => '','options_checkbox_checked' => '','options_checkbox_tip' => '','options_checkbox_error' => '','options_text_tip' => '','options_text_regex' => '','options_text_error' => '',),'no_of_employees' => array ('label' => 'Number of Employees','fieldid' => 'number_of_employees','type' => 'select','required' => '','options_select_values' => '1-20'."\r\n".'21-50'."\r\n".'51-100'."\r\n".'101-500'."\r\n".'500-1,000'."\r\n".'1,001-5,000'."\r\n".'5,001-10,000'."\r\n".'More than 10,000','options_select_default' => '','options_select_default_text' => 'Select ...','options_select_tip' => '','options_select_error' => '','options_html_content' => '','options_date_range' => '','options_date_range_seperator' => '','options_date_tip' => '','options_date_error' => '','options_date_error_format' => '','options_date_error_end' => '','options_time_range' => '','options_time_range_seperator' => '','options_time_tip' => '','options_time_error' => '','options_time_error_format' => '','options_time_error_end' => '','options_time_error_start' => '','options_selection_values' => '','options_selection_tip' => '','options_selection_error' => '','options_checkbox_checked' => '','options_checkbox_tip' => '','options_checkbox_error' => '','options_text_tip' => '','options_text_regex' => '','options_text_error' => '',),'comments' => array ('label' => 'Comments','fieldid' => 'comments','type' => 'textarea','required' => '','options_select_values' => '','options_select_default' => '','options_select_default_text' => 'Select ...','options_select_tip' => '','options_select_error' => '','options_html_content' => '','options_date_range' => '','options_date_range_seperator' => '','options_date_tip' => '','options_date_error' => '','options_date_error_format' => '','options_date_error_end' => '','options_time_range' => '','options_time_range_seperator' => '','options_time_tip' => '','options_time_error' => '','options_time_error_format' => '','options_time_error_end' => '','options_time_error_start' => '','options_selection_values' => '','options_selection_tip' => '','options_selection_error' => '','options_checkbox_checked' => '','options_checkbox_tip' => '','options_checkbox_error' => '','options_text_tip' => '','options_text_regex' => '','options_text_error' => '',),),);
			$result = $wpdb->insert(EM_META_TABLE, array('object_id'=>0, 'meta_key' => 'attendee-form', 'meta_value' => serialize($zoom_attendee_data)));
			if( $result === false ){
				/* @var \WP_Error $attendee_form_id */
				$EM_Notices->add_error($wpdb->last_error, true);
			}else{
				$attendee_form_id = $wpdb->insert_id;
				$EM_Notices->add_confirm(__('A new attendee form called "Zoom Attendee" has been created with all the available Zoom questions, make sure you select this attendee form for your Zoom events in their booking settings. Apart from the email and first/last name fields, you can remove any fields you do not need. Any additional questions would be added as custom questions to Zoom.'), true);
				wp_redirect( admin_url('edit.php?att_form_id='.$attendee_form_id .'&post_type=event&page=events-manager-forms-editor') );
				exit();
			}
		}
    }
	
	public static function em_settings_apps_header() {
		$link = '<a href="https://wp-events-plugin.com/documentation/locations/zoom">'.__('documentation', 'events-manager-zoom').'</a>';
		echo '<p>'. sprintf(esc_html__('For further setup instructions, please visit our %s page.', 'events-manager-zoom'), $link).'</p>';
	}
    
    public static function em_settings_apps_footer() {
		echo '<h4>'.esc_html__('Pro Integration', 'events-manager-zoom').'</h4>';
		if( !class_exists('EM_Gateways') ){
			echo '<p>'.esc_html__('Upgrade to Events Manager Pro and access tighter integration features with Zoom:', 'events-manager-zoom').'</p><ul>';
			echo '<li>'.esc_html__('Accept online payments for your registrants.', 'events-manager-zoom').'</li>';
			echo '<li>'.esc_html__('Allow for multiple attendees in one booking with custom attendee forms.', 'events-manager-zoom').'</li>';
			echo '<li>'.esc_html__('Automatically register custom questions for each registrant via our custom booking forms.', 'events-manager-zoom').'</li>';
			echo '</ul>';
			echo '<p><a href="https://eventsmanagerpro.com/gopro/" class="button-primary" target="_blank">'. esc_html__('Upgrade Now!', 'events-manager-zoom').'</a> ';
			echo '<a href="https://wp-events-plugin.com/integrations/zoom/#pro" class="button-secondary" target="_blank">'. esc_html__('More Info', 'events-manager-zoom').'</a></p>';
		}else{
			echo '<p>'. esc_html__("By default, bookings made via Events Manager to an event with a Zoom Meeting/Webinar will create a single registration based on the details of the person making a booking.", 'events-manager-zoom').'</p>';
			echo '<p>'. esc_html__("All address-related fields will be linked via the Gateway field mapping functionality which you'll find in the Pro Form Editor.", 'events-manager-zoom').'</p>';
			echo '<p>'. esc_html__("If you would like to enable bookings for individual attendees, one for each space in a booking, you'll need to assign events a valid attendee form which contains at least an email, first and last name field.", 'events-manager-zoom').'</p>';
			echo '<p>'. esc_html__("In both cases, any non-standard Zoom fields will still be registered on Zoom as a custom question.", 'events-manager-zoom').'</p>';
			$attendee_form_link = add_query_arg('create_zoom_attendee_form', wp_create_nonce('create-zoom-attedee-form'));
			echo '<p><a href="'. esc_url($attendee_form_link) .'" class="button-secondary">'. esc_html__('Create Attendee Form Template') . '</a> - '. esc_html__('Click this button to quickly create a new attendee form with all the Zoom standard fields.').'</p>';
			echo '<p><a href="https://wp-events-plugin.com/documentation/location-types/zoom/" class="button-secondary" target="_blank">'. esc_html__('More Info', 'events-manager-zoom').'</a></p>';
		}
    }
}
Zoom_API_Admin_Settings::init();