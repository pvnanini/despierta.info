(function(a){window.WPUF_Uploader=function(b,c,d,e,f,g){if(this.removed_files=[],this.container=c,this.browse_button=b,this.max=d||1,this.count=a('#'+c).find('.wpuf-attachment-list > li').length,this.perFileCount=0,this.UploadedFiles=0,!a('#'+b).length)return;return a("ul.wpuf-attachment-list").sortable({placeholder:"highlight"}),a("ul.wpuf-attachment-list").disableSelection(),this.uploader=new plupload.Uploader({runtimes:'html5,html4',browse_button:b,container:c,multipart:!0,multipart_params:{action:'wpuf_upload_file',form_id:a('#'+b).data('form_id')},urlstream_upload:!0,file_data_name:'wpuf_file',max_file_size:g+'kb',url:wpuf_frontend_upload.plupload.url+'&type='+e,flash_swf_url:wpuf_frontend_upload.flash_swf_url,filters:[{title:'Allowed Files',extensions:f}]}),this.uploader.bind('Init',a.proxy(this,'init')),this.uploader.bind('FilesAdded',a.proxy(this,'added')),this.uploader.bind('QueueChanged',a.proxy(this,'upload')),this.uploader.bind('UploadProgress',a.proxy(this,'progress')),this.uploader.bind('Error',a.proxy(this,'error')),this.uploader.bind('FileUploaded',a.proxy(this,'uploaded')),this.uploader.init(),a('#'+c).on('click','a.attachment-delete',a.proxy(this.removeAttachment,this)),this.uploader},WPUF_Uploader.prototype={init:function(b,c){this.showHide(),a('#'+this.container).prepend('<div class="wpuf-file-warning"></div>')},showHide:function(){if(this.count>=this.max){this.count>this.max?a('#'+this.container+' .wpuf-file-warning').html(wpuf_frontend_upload.warning):a('#'+this.container+' .wpuf-file-warning').html(wpuf_frontend_upload.warning),a('#'+this.container).find('.file-selector').hide();return}a('#'+this.container+' .wpuf-file-warning').html(''),a('#'+this.container).find('.file-selector').show()},added:function(b,c){var d=a('#'+this.container).find('.wpuf-attachment-upload-filelist');this.showHide(),a.each(c,function(c,b){a(".wpuf-submit-button").attr("disabled","disabled"),d.append('<div class="upload-item" id="'+b.id+'"><div class="progress progress-striped active"><div class="bar"></div></div><div class="filename original">'+b.name+' ('+plupload.formatSize(b.size)+') <b></b>'+'</div></div>')}),b.refresh(),b.start()},upload:function(a){this.count=a.files.length-this.removed_files.length,this.showHide()},progress:function(d,b){var c=a('#'+b.id);a('.bar',c).css({width:b.percent+'%'}),a('.percent',c).html(b.percent+'%')},error:function(d,b){a('#'+this.container).find('#'+b.file.id).remove();var c='';switch(b.code){case-600:c=wpuf_frontend_upload.plupload.size_error;break;case-601:c=wpuf_frontend_upload.plupload.type_error;break;default:c='Error #'+b.code+': '+b.message;break}alert(c),this.count-=1,this.showHide(),this.uploader.refresh()},uploaded:function(h,c,d){var e,f,g,b,i,j,k;try{e=a.parseJSON(d.response)}catch(a){f=!0}if(g=this,a('#'+c.id+" b").html("100%"),a('#'+c.id).remove(),f?(this.perFileCount++,this.UploadedFiles++,b=a('#'+this.container).find('.wpuf-attachment-list'),b.append(d.response),this.perFileCount>this.max&&(i=a('.wpuf-image-wrap:last a.attachment-delete',b).data('attach-id'),g.removeExtraAttachment(i),a('.wpuf-image-wrap',b).last().remove(),this.perFileCount--)):(alert(e.data.replace(/(<([^>]+)>)/ig,'')),h.files.pop(),this.count-=1,this.showHide()),j=this.UploadedFiles,k=h.files.length,this.count>=this.max&&a('#'+this.container).find('.file-selector').hide(),k===j){if(typeof grecaptcha!='undefined'&&a('.wpuf-form-add #g-recaptcha-response').length)if(!grecaptcha.getResponse().length)return;a(".wpuf-submit-button").removeAttr("disabled")}},removeAttachment:function(d){d.preventDefault();var b=this,c=a(d.currentTarget);swal({text:wpuf_frontend_upload.confirmMsg,type:'warning',showCancelButton:!0,confirmButtonColor:'#d54e21',confirmButtonText:wpuf_frontend_upload.delete_it,cancelButtonText:wpuf_frontend_upload.cancel_it,confirmButtonClass:'btn btn-success',cancelButtonClass:'btn btn-danger'}).then(function(){var a={attach_id:c.data('attach-id'),nonce:wpuf_frontend_upload.nonce,action:'wpuf_file_del'};b.removed_files.push(a),jQuery('#del_attach').val(c.data('attach-id')),jQuery.post(wpuf_frontend_upload.ajaxurl,a,function(){b.perFileCount--,c.parent().parent().remove(),b.count-=1,b.showHide(),b.uploader.refresh()})})},removeExtraAttachment:function(c){var a=this,b={attach_id:c,nonce:wpuf_frontend_upload.nonce,action:'wpuf_file_del'};this.removed_files.push(b),jQuery.post(wpuf_frontend_upload.ajaxurl,b,function(){a.count-=1,a.showHide(),a.uploader.refresh()})}}})(jQuery)